# Task 6: サブエージェントを作ってみる

## 目的
Claude Codeのサブエージェント機能を理解し、プロジェクトのコードをレビューするカスタムサブエージェントを作成する

## 所要時間
約20分

## 前提条件
- Task 1-5が完了していること
- example1プロジェクトが存在すること

## サブエージェントとは？

サブエージェント（Sub-agent）は、特定のタスクを自律的に実行する専門的なAIアシスタントです。

### 特徴
- **専門性**: 特定のタスクに特化した指示を持つ
- **独立したコンテキスト**: メインの会話とは別のコンテキストウィンドウで動作
- **自律性**: 複雑なタスクを独立して実行
- **再利用性**: 一度定義すれば繰り返し使える

### Claude Code標準のサブエージェント例
- `general-purpose`: 汎用的なタスク
- `code-reviewer`: コードレビュー専門
- その他のビルトインエージェント

## なぜカスタムサブエージェントが必要？

標準エージェントでカバーできない、プロジェクト固有のニーズに対応できます：

- プロジェクト特有のコーディング規約のチェック
- カスタムレビュー基準の適用
- 特定のフレームワーク（Next.js）に特化したレビュー
- チームのベストプラクティスの適用

## 実践課題

### 課題1: サブエージェント設定ファイルの理解

カスタムサブエージェントは以下のディレクトリに保存します：

**プロジェクトレベル:**
```
.claude/agents/
```

**ユーザーレベル（全プロジェクト共通）:**
```
~/.claude/agents/
```

### 課題2: ファイル形式を理解する

サブエージェントは **Markdownファイル** として作成します。

**ファイル名:** `[エージェント名].md`

**構造:**
```markdown
---
name: your-sub-agent-name
description: このサブエージェントをいつ使うべきか
tools: Read, Grep, Glob  # オプション
model: sonnet  # オプション
---

ここにシステムプロンプトを記述します。
エージェントの役割や実行すべき内容を詳しく説明してください。
```

### 課題3: Next.js専門レビューエージェントを作成

#### 1. agentsディレクトリを作成

```bash
mkdir -p example1/.claude/agents
```

#### 2. Next.jsレビューエージェントを作成

`example1/.claude/agents/nextjs-reviewer.md`を作成：

```markdown
---
name: nextjs-reviewer
description: Next.js 15プロジェクトのコードレビューを実行する専門エージェント
tools: Read, Glob, Grep
---

あなたはNext.js 15の専門家です。以下の観点でコードをレビューしてください：

## レビュー観点

### 1. Next.js 15のベストプラクティス
- App Routerの適切な使用
- Server Components vs Client Componentsの使い分け
- データフェッチングの最適化
- ファイル規約（layout.tsx, page.tsx, loading.tsx等）の遵守

### 2. パフォーマンス
- 不要な"use client"ディレクティブの検出
- 動的インポートの活用機会
- 画像最適化（next/image）の使用
- フォント最適化の確認

### 3. TypeScript
- 型の適切な定義
- any型の使用を避ける
- Propsの型定義
- 型の再利用性

### 4. コード品質
- コンポーネントの適切なサイズ（200行以下推奨）
- 再利用可能な設計
- 適切な命名規則（camelCase, PascalCase）
- コードの重複を避ける

### 5. セキュリティ
- 環境変数の適切な管理（NEXT_PUBLIC_プレフィックス）
- XSS対策
- 外部入力の検証

## 出力形式

レビュー結果は日本語で、以下の形式で報告してください：

1. **総評**
2. **発見された問題点**（優先度順）
   - 問題の説明
   - 該当箇所
   - 修正案
3. **改善提案**
4. **良い点**

具体的なコード例を含めて説明してください。
```

#### 3. エージェントの内容を理解する

**YAML Frontmatter（---で囲まれた部分）:**
- `name`: エージェントの識別名
- `description`: エージェントの説明（Claudeがいつ使うべきか判断する）
- `tools`: 使用可能なツール（カンマ区切り）
- `model`: 使用するモデル（オプション、デフォルトはsonnet）

**本文（Markdownセクション）:**
- エージェントに与える詳細な指示
- システムプロンプト
- マークダウン形式で自由に記述可能

### 課題4: サブエージェントを使ってみる

#### 方法1: 明示的にエージェントを指定

Claude Codeで以下のように指示：

```
nextjs-reviewerサブエージェントを使って、example1/app/page.tsxをレビューしてください
```

#### 方法2: /agentsコマンドを使用

```
/agents
```

利用可能なエージェント一覧が表示され、選択できます。

#### 方法3: スラッシュコマンドから呼び出す

`.claude/commands/review-nextjs.md`を作成：

```markdown
nextjs-reviewerサブエージェントを使って、以下のファイルをレビューしてください：

- app/page.tsx
- app/layout.tsx
- すべてのコンポーネントファイル

Next.js 15のベストプラクティスに従っているか確認してください。
```

使用：
```
/review-nextjs
```

### 課題5: より実践的なエージェントを追加

#### セキュリティチェックエージェント

`example1/.claude/agents/security-checker.md`を作成：

```markdown
---
name: security-checker
description: セキュリティの観点でコードをチェックする専門エージェント
tools: Read, Glob, Grep
---

あなたはセキュリティ専門家です。以下のセキュリティ観点でコードをチェックしてください：

## チェック項目

1. **環境変数の管理**
   - .envファイルの機密情報
   - NEXT_PUBLIC_プレフィックスの適切な使用
   - 環境変数のハードコード

2. **脆弱性**
   - SQLインジェクション
   - XSS（クロスサイトスクリプティング）
   - CSRF対策

3. **認証・認可**
   - 認証の実装状況
   - セッション管理
   - アクセス制御

4. **機密情報**
   - APIキーのハードコード
   - パスワードの平文保存
   - トークンの適切な管理

5. **依存関係**
   - 既知の脆弱性を持つパッケージ
   - 古いバージョンの使用

## 出力形式

- 深刻度（高/中/低）
- 問題の詳細
- 影響範囲
- 修正方法

日本語で報告してください。
```

#### パフォーマンス最適化エージェント

`example1/.claude/agents/performance-optimizer.md`を作成：

```markdown
---
name: performance-optimizer
description: Next.jsアプリケーションのパフォーマンスを分析し最適化を提案
tools: Read, Glob, Grep
---

あなたはNext.jsパフォーマンス最適化の専門家です。

## 分析項目

### 1. バンドルサイズ
- 不要な依存関係
- 動的インポートの活用

### 2. レンダリング最適化
- 不要なClient Componentの検出
- Server Componentsへの移行機会
- Suspenseの活用

### 3. 画像・フォント最適化
- next/imageの使用状況
- 画像フォーマット（WebP、AVIF）
- フォント最適化（next/font）

### 4. データフェッチング
- fetch APIの適切な使用
- キャッシュ戦略
- Parallel vs Sequential fetching

### 5. コード分割
- ルートベースの分割
- コンポーネントレベルの分割
- React.lazyの活用

## 出力形式

各項目について：
- 現状分析
- 改善提案
- 期待される効果
- 実装例

優先度順に日本語で報告してください。
```

### 課題6: エージェントを実際に使ってみる

#### 1. Next.jsレビューを実行

```
nextjs-reviewerサブエージェントを使って、example1プロジェクトをレビューしてください
```

または

```
/review-nextjs
```

#### 2. セキュリティチェックを実行

```
security-checkerサブエージェントでexample1プロジェクトのセキュリティチェックを実行してください
```

#### 3. パフォーマンス最適化を実行

```
performance-optimizerサブエージェントでexample1/app/page.tsxを分析してください
```

#### 4. Claudeに自動判断させる

タスクの説明だけを伝えると、Claudeが適切なサブエージェントを自動的に選択します：

```
example1プロジェクトのコードをレビューして、セキュリティとパフォーマンスの問題を指摘してください
```

Claudeは自動的に適切なサブエージェント（nextjs-reviewer、security-checker、performance-optimizer）を使い分けます。

## サブエージェントの設計のコツ

### 1. 単一責任の原則

❌ 悪い例：
```markdown
---
name: all-checker
description: すべてをチェックする
---

コードをチェックしてください
```

✅ 良い例：
```markdown
---
name: accessibility-checker
description: アクセシビリティの観点でReactコンポーネントをチェック
---

以下のアクセシビリティ基準に従ってチェック：
- ARIA属性の適切な使用
- キーボードナビゲーション
- セマンティックHTML
...
```

### 2. 詳細で具体的な指示

システムプロンプトには：
- チェックすべき項目のリスト
- 期待する出力形式
- 具体例や基準

### 3. 適切なツールの選択

- `Read`: ファイルを読む
- `Grep`: コード検索
- `Glob`: ファイルパターン検索
- `Bash`: コマンド実行
- `Edit`, `Write`: コード修正（必要な場合のみ）

**推奨**: レビューエージェントには`Read, Glob, Grep`のみ許可

### 4. プロジェクトのコンテキストを含める

- コーディング規約
- 使用技術スタック
- チームのベストプラクティス

## 確認事項

- [ ] `.claude/agents/`ディレクトリを作成した
- [ ] カスタムサブエージェントを定義した（.md形式）
- [ ] YAML frontmatterを正しく記述した
- [ ] エージェントを実行できた
- [ ] レビュー結果が期待通りだった

## サブエージェント vs カスタムコマンドの使い分け

### カスタムコマンド（Task 5）
- シンプルな指示のショートカット
- Claudeメインセッションが実行
- 対話的な作業向け
- 例：`/review` → レビュー指示を展開

### サブエージェント（Task 6）
- 複雑な自律的タスク
- 独立したコンテキストで実行
- 専門的な分析・レビュー
- より高度な問題解決
- 例：`nextjs-reviewer` → 専門的なNext.jsレビューを実行

## 応用課題（発展）

### 1. テスト自動生成エージェント

`example1/.claude/agents/test-generator.md`:

```markdown
---
name: test-generator
description: Reactコンポーネントの包括的なテストを自動生成
tools: Read, Write, Glob
---

指定されたReactコンポーネントのテストを作成してください。

使用技術：
- Vitest
- React Testing Library

カバーすべき内容：
1. 基本的なレンダリング
2. Propsのバリエーション
3. ユーザーインタラクション
4. エッジケース
5. エラーハンドリング

テストファイル名：`[component].test.tsx`
日本語でコメントを記述してください。
```

### 2. ドキュメント生成エージェント

`example1/.claude/agents/doc-generator.md`:

```markdown
---
name: doc-generator
description: プロジェクトの包括的なドキュメントを生成
tools: Read, Write, Glob, Grep
---

プロジェクト全体を分析し、README.mdを生成してください。

含めるべき内容：
1. プロジェクト概要
2. 技術スタック
3. ディレクトリ構造
4. セットアップ手順
5. 主要機能の説明
6. 開発ワークフロー
7. デプロイ方法

日本語で、初めての開発者が理解できるように記述してください。
```

### 3. マイグレーションエージェント

`example1/.claude/agents/migration-helper.md`:

```markdown
---
name: migration-helper
description: Next.js 14から15へのマイグレーションを支援
tools: Read, Edit, Glob, Grep
---

Next.js 14から15への移行を支援してください。

チェック項目：
1. App Routerへの移行状況
2. Server Actionsの使用
3. Metadata APIの変更
4. 非推奨APIの使用
5. 新機能の活用機会

出力：
- 移行が必要な箇所のリスト
- 修正方法
- 破壊的変更への対応

可能なら自動修正を提案してください。
```

## Claudeが生成したエージェントを使う

Claude Codeに以下のように依頼すると、自動的にエージェントを生成してくれます：

```
Next.jsのアクセシビリティをチェックするサブエージェントを作成して、
それを使ってexample1プロジェクトをチェックしてください
```

Claudeが：
1. エージェント定義ファイルを自動生成
2. そのエージェントを使ってタスクを実行

してくれます！

## 次のステップ

✅ カスタムサブエージェントの作成をマスターしました！

### さらに学ぶには：
1. より専門的なエージェントを作成
2. チーム全体でエージェントを共有
3. CI/CDパイプラインでエージェントを活用
4. エージェントの改善を繰り返す

## トラブルシューティング

### エージェントが認識されない
- ファイル名が`.md`で終わっているか確認
- `.claude/agents/`ディレクトリにあるか確認
- YAML frontmatterの形式が正しいか確認（`---`で囲む）

### YAML形式エラー
```markdown
---
name: my-agent
description: 説明文
tools: Read, Glob, Grep
---
```
- コロン(`:`)の後にスペースが必要
- インデントはスペース2つ
- 引用符は不要

### エージェントが期待通り動作しない
- システムプロンプトをより具体的に
- チェック項目を明確にリスト化
- 出力形式を明示的に指定
- 必要なツールが許可されているか確認

### toolsの指定ミス
- ❌ `tools: ["Read", "Glob"]` （JSON形式）
- ✅ `tools: Read, Glob, Grep` （カンマ区切り）

## 振り返り

1. サブエージェントを使うことで、どのような作業が効率化できましたか？
2. 他にどんなエージェントがあると便利だと思いますか？
3. チームでエージェントを共有する場合、どのような管理方法が良いと思いますか？

## ヒント

- エージェントの定義は試行錯誤しながら改善していきましょう
- 実際のレビュー結果を見て、システムプロンプトを調整します
- チームのコーディング規約をシステムプロンプトに組み込むと効果的です
- エージェントファイルはGit管理して、チーム全体で共有しましょう
- プロジェクトレベル（`.claude/agents/`）とユーザーレベル（`~/.claude/agents/`）を使い分けましょう
