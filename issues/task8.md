# Task 8: Vitestã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIã‚’ãƒ†ã‚¹ãƒˆã—ã‚ˆã†

## ç›®çš„
Vitestã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€Next.jsã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã™ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹

## æ‰€è¦æ™‚é–“
ç´„30-40åˆ†

## å‰ææ¡ä»¶
- Task 1-7ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨
- example1ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã“ã¨
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ï¼ˆ`/api/health`ï¼‰

## ã“ã®ã‚¿ã‚¹ã‚¯ã§å­¦ã¶ã“ã¨
- Vitestã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•
- Next.js API Routesã®ãƒ†ã‚¹ãƒˆæ‰‹æ³•
- ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã®åŸºç¤
- Claude Codeã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆä½œæˆã®åŠ¹ç‡åŒ–
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª

## ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³

**example1ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Vitestã‚’å°å…¥ã—ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼**

## ğŸ“š Vitestã¨ã¯ï¼Ÿ

[Vitest](https://vitest.dev/)ã¯ã€Viteãƒ™ãƒ¼ã‚¹ã®è¶…é«˜é€Ÿãªãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

### ç‰¹å¾´
- âš¡ **é«˜é€Ÿ**: Viteã®ãƒ‘ãƒ¯ãƒ¼ã§çˆ†é€Ÿãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- ğŸ”§ **è¨­å®šä¸è¦**: Viteè¨­å®šã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿
- ğŸ¯ **Jestäº’æ›**: Jestã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«ãªAPI
- ğŸ“Š **ã‚«ãƒãƒ¬ãƒƒã‚¸**: ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒ¼ãƒˆ
- ğŸ”¥ **HMR**: ãƒ†ã‚¹ãƒˆã‚‚ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰

### ãªãœVitestã‚’ä½¿ã†ã®ã‹ï¼Ÿ

| ãƒ„ãƒ¼ãƒ« | ç‰¹å¾´ | é€Ÿåº¦ |
|-------|------|------|
| **Vitest** | Viteãƒ™ãƒ¼ã‚¹ã€æœ€æ–°ã€Next.js 15ã¨ç›¸æ€§è‰¯ã„ | âš¡âš¡âš¡ |
| Jest | æœ€ã‚‚åºƒãä½¿ã‚ã‚Œã¦ã„ã‚‹ | ğŸ¢ |
| Mocha | æŸ”è»Ÿã ãŒè¨­å®šãŒè¤‡é›‘ | ğŸ¢ |

## ğŸš€ å®Ÿè£…ã®é€²ã‚æ–¹

### ã‚¹ãƒ†ãƒƒãƒ—1: Vitestã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ï¼ˆ5åˆ†ï¼‰

#### 1-1. Claude Codeã«ä¾é ¼ã™ã‚‹

```
example1ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Vitestã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ã§ã™ã€‚

ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
1. vitestã€@vitejs/plugin-reactã€happy-dom ã‚’devDependenciesã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. package.jsonã«ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 
   - test: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
   - test:watch: ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
   - test:coverage: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
```

#### 1-2. æœŸå¾…ã•ã‚Œã‚‹çµæœ

Claude CodeãŒä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
cd example1
npm install --save-dev vitest @vitest/ui happy-dom @types/node
```

`package.json`ã«ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã™ï¼š

```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage"
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—2: Vitestè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆ5åˆ†ï¼‰

#### 2-1. Claude Codeã«ä¾é ¼ã™ã‚‹

```
Vitestã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆvitest.config.tsï¼‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®è¨­å®šã‚’å«ã‚ã¦ãã ã•ã„ï¼š
- Next.jsã®ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆ@/*ï¼‰ã‚’è§£æ±º
- happy-domã‚’ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ã—ã¦ä½¿ç”¨
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®šï¼ˆ**/*.test.ts, **/*.test.tsxï¼‰
- ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆdescribe, it, expectç­‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸è¦ã«ã™ã‚‹ï¼‰
```

#### 2-2. æœŸå¾…ã•ã‚Œã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

`example1/vitest.config.ts`:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'happy-dom',
    globals: true,
    setupFiles: ['./vitest.setup.ts'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ï¼ˆ10åˆ†ï¼‰

```
example1/src/app/api/health/route.tsã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«: example1/src/app/api/health/route.test.ts

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š
1. GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™ã“ã¨
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã« "status": "ok" ãŒå«ã¾ã‚Œã‚‹ã“ã¨
3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã« "timestamp" ãŒå«ã¾ã‚Œã‚‹ã“ã¨
4. timestampãŒISO 8601å½¢å¼ã§ã‚ã‚‹ã“ã¨

Next.jsã®Route Handlerã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
```

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆ5åˆ†ï¼‰

#### 4-1. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ

```bash
cd example1
npm run test
```

#### 4-2. æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
âœ“ src/app/api/health/route.test.ts (5)
  âœ“ GET /api/health (5)
    âœ“ 200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™ã“ã¨
    âœ“ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«statusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã“ã¨
    âœ“ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«timestampãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã“ã¨
    âœ“ timestampãŒISO 8601å½¢å¼ã§ã‚ã‚‹ã“ã¨
    âœ“ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®Content-TypeãŒJSONã§ã‚ã‚‹ã“ã¨

Test Files  1 passed (1)
     Tests  5 passed (5)
  Start at  XX:XX:XX
  Duration  XXXms
```

#### 4-3. ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ

ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦è‡ªå‹•çš„ã«å†å®Ÿè¡Œï¼š

```bash
npm run test:watch
```

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã™ã‚‹ï¼ˆ5åˆ†ï¼‰

#### 5-1. ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
@vitest/coverage-v8ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„
```

```bash
npm install --save-dev @vitest/coverage-v8
```

#### 5-2. vitest.config.tsã«ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®šã‚’è¿½åŠ 

```typescript
export default defineConfig({
  // ... æ—¢å­˜ã®è¨­å®š
  test: {
    // ... æ—¢å­˜ã®è¨­å®š
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'json'],
      include: ['src/app/api/**/*.ts'],
      exclude: ['**/*.test.ts', '**/*.test.tsx'],
    },
  },
});
```

#### 5-3. ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

```bash
npm run test:coverage
```

æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼š

```
Coverage report from v8
-----------------------|---------|----------|---------|---------|
File                   | % Stmts | % Branch | % Funcs | % Lines |
-----------------------|---------|----------|---------|---------|
All files              |     100 |      100 |     100 |     100 |
 api/health/route.ts   |     100 |      100 |     100 |     100 |
-----------------------|---------|----------|---------|---------|
```

ã‚«ãƒãƒ¬ãƒƒã‚¸HTMLãƒ¬ãƒãƒ¼ãƒˆã¯ `example1/coverage/index.html` ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ†ã‚¹ãƒˆã®ç†è§£ã‚’æ·±ã‚ã‚‹ï¼ˆ5-10åˆ†ï¼‰

#### 6-1. Claude Codeã«è³ªå•ã™ã‚‹

```
ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã€ä»¥ä¸‹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

1. describe ã¨ it ã®å½¹å‰²ã®é•ã„ã¯ï¼Ÿ
2. expect().toBe() ã¨ expect().toEqual() ã®é•ã„ã¯ï¼Ÿ
3. ãªãœ async/await ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
4. response.json() ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
5. toMatch() ã§Regexã‚’ä½¿ã†ç†ç”±ã¯ï¼Ÿ
```

#### 6-2. ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ã‚‹

è‡ªåˆ†ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```
ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

1. timestampãŒç¾åœ¨æ™‚åˆ»ã«è¿‘ã„ã“ã¨ï¼ˆ1ç§’ä»¥å†…ï¼‰
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«ä½™è¨ˆãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ã“ã¨
```

æœŸå¾…ã•ã‚Œã‚‹è¿½åŠ ãƒ†ã‚¹ãƒˆï¼š

```typescript
it('timestampãŒç¾åœ¨æ™‚åˆ»ã«è¿‘ã„ã“ã¨ï¼ˆ1ç§’ä»¥å†…ï¼‰', async () => {
  const before = new Date();
  const response = await GET();
  const after = new Date();
  const body = await response.json();

  const timestamp = new Date(body.timestamp);
  expect(timestamp.getTime()).toBeGreaterThanOrEqual(before.getTime());
  expect(timestamp.getTime()).toBeLessThanOrEqual(after.getTime());
});

it('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å«ã¾ã‚Œã‚‹ã“ã¨', async () => {
  const response = await GET();
  const body = await response.json();

  const expectedKeys = ['status', 'timestamp'];
  const actualKeys = Object.keys(body);

  expect(actualKeys.sort()).toEqual(expectedKeys.sort());
});
```

## âœ… ç¢ºèªäº‹é …

- [ ] Vitestã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ
- [ ] vitest.config.tsã‚’ä½œæˆã—ãŸ
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ãŸ
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ãŸ
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ãŸï¼ˆ100%ï¼‰
- [ ] ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã®ä½¿ã„æ–¹ã‚’ç†è§£ã—ãŸ
- [ ] Claude Codeã§ãƒ†ã‚¹ãƒˆä½œæˆã‚’åŠ¹ç‡åŒ–ã§ããŸ
